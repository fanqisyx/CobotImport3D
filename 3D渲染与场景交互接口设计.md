### **3D渲染与场景交互接口设计**

**1. 3D渲染引擎选型**

经过讨论，我们已达成共识，选择以下技术方案作为本软件的3D渲染引擎：

- **核心UI框架：** WPF (Windows Presentation Foundation)

- **3D渲染库：** 集成 **HelixToolkit** (推荐其WPF/SharpDX版本，以获得更好的性能和功能)

**选择理由：**

- **技术栈一致性：** 与 .NET Core 8 (C#) 和 WPF 的核心技术栈高度一致，降低开发门槛和学习曲线。

- **功能与性能平衡：** HelixToolkit 在WPF基础上提供了足够强大的3D渲染能力，能满足项目对模型导入、路径绘制、机械臂显示、基本仿真验证等核心需求，且性能对于多数工业应用场景是足够的。

- **开发效率：** 能够更快速地实现3D相关功能，使开发团队能将更多精力集中在路径规划、机器人控制等核心业务逻辑上。

- **易于集成：** 作为WPF的扩展库，其集成过程相对简便，与现有2D UI的融合也最为自然。

**2. 核心层向插件暴露的3D场景接口设计**

为了实现插件与3D视图的有效交互，核心层将定义并暴露一套抽象接口。这些接口将允许插件：在3D场景中显示其数据、获取和操作场景中的对象、以及响应3D视图的用户交互事件。

**设计原则：**

- **抽象性：** 接口不应依赖于 HelixToolkit 的具体实现细节，而是基于我们已定义的核心数据结构。

- **功能完整性：** 覆盖插件与3D视图交互的绝大部分需求。

- **安全性：** 提供受控的访问方式，避免插件直接修改核心渲染循环或造成冲突。

- **唯一标识符 (ID)：** 所有场景对象都应有唯一ID，以便插件引用和操作。

- **数据流向：** 核心层负责数据转换与渲染；核心层通过事件通知插件交互结果。

- **线程安全：** 考虑跨线程操作的安全性。

**初步接口构想：**

#### 2.1 `I3DSceneManager` (场景管理接口)

- **目的：** 提供添加、移除、更新和查询3D场景对象的通用方法。

- **命名空间：** `CorePlatform` (建议)

C#

```
namespace CorePlatform
{
    public interface I3DSceneManager
    {
        /// <summary>
        /// 添加或更新工件模型到3D场景。
        /// </summary>
        void AddWorkpieceModel(WorkpieceModel model);
        /// <summary>
        /// 从3D场景中移除指定ID的工件模型。
        /// </summary>
        void RemoveWorkpieceModel(string modelId);
        /// <summary>
        /// 更新3D场景中现有工件模型的数据。
        /// </summary>
        void UpdateWorkpieceModel(WorkpieceModel model);

        /// <summary>
        /// 添加或更新路径序列到3D场景。
        /// </summary>
        void AddPathSequence(PathSequence sequence);
        /// <summary>
        /// 从3D场景中移除指定ID的路径序列。
        /// </summary>
        void RemovePathSequence(string sequenceId);
        /// <summary>
        /// 更新3D场景中现有路径序列的数据。
        /// </summary>
        void UpdatePathSequence(PathSequence sequence);

        /// <summary>
        /// 设置当前3D场景中使用的机械臂配置。
        /// </summary>
        void SetRobotConfiguration(RobotConfiguration robotConfig);
        /// <summary>
        /// 更新指定机械臂的当前位姿，用于仿真动画。
        /// </summary>
        void UpdateRobotPose(string robotId, Pose newPose);

        /// <summary>
        /// 重置3D相机的视角到默认状态。
        /// </summary>
        void ResetCamera();
        /// <summary>
        /// 调整相机视角，使所有场景内容可见。
        /// </summary>
        void ZoomExtents();

        // 潜在的事件：当3D对象被选中时触发（插件可订阅此事件以响应用户选择）
        // event Action<string> OnObjectSelected; 
    }
}
```

#### 2.2 `I3DInteractionProvider` (3D交互提供接口)

- **目的：** 允许插件注册监听3D视图的用户交互事件（如鼠标点击、选择），并提供拾取（Picking）功能。

- **命名空间：** `CorePlatform` (建议)

C#

```
namespace CorePlatform
{
    public interface I3DInteractionProvider
    {
        /// <summary>
        /// 注册一个监听器，用于响应3D场景中对象被点击的事件。
        /// 回调函数参数为被点击对象的唯一ID。
        /// </summary>
        void RegisterClickListener(Action<string> onObjectClicked);
        /// <summary>
        /// 取消注册一个3D对象点击事件监听器。
        /// </summary>
        void UnregisterClickListener(Action<string> onObjectClicked);

        // 潜在的框选事件监听器
        // void RegisterSelectionBoxListener(Action<IEnumerable<string>> onObjectsSelected);

        /// <summary>
        /// 在指定屏幕坐标处执行3D拾取操作，返回被拾取对象的唯一ID。
        /// 如果没有对象被拾取，则返回null。
        /// </summary>
        string PickObjectAtScreenCoordinate(double screenX, double screenY);
        // 潜在的矩形区域拾取功能
        // IEnumerable<string> PickObjectsInRect(double x1, double y1, double x2, double y2);

        /// <summary>
        /// 设置3D视图当前的交互模式（例如：导航、选择、绘制路径）。
        /// </summary>
        void SetInteractionMode(InteractionMode mode);
    }

    /// <summary>
    /// 定义3D视图的交互模式。
    /// </summary>
    public enum InteractionMode
    {
        Navigate,       // 导航模式（旋转、平移、缩放）
        Select,         // 选择模式（点击选择对象）
        DrawPath        // 路径绘制模式
        // 可以根据需要添加其他交互模式
    }
}
```
