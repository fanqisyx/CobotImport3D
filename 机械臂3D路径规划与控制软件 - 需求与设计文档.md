# 机械臂3D路径规划与控制软件 - 需求与设计文档

## 1. 软件概述与核心需求

### 1.1 核心目的

本软件旨在解决机械臂在处理不规则物体（如异形工件）时，传统人工示教或路径规划方法效率低下、甚至无法实现的问题。通过引入**3D模型导入**和**人工点选路径**的功能，实现机械臂对不规则物体的**精准、高效操作**，特别适用于**喷涂、焊接、点胶**等需要沿物体表面连续运动的应用场景。

### 1.2 主要用户与任务

- **主要用户：** 调试协作机械臂的工程师。

- **主要任务：**
  
  - 导入三维工件模型。
  
  - 在三维模型上直观地**点选、绘制和编辑机械臂的运动路径**。
  
  - 配置每段路径的运动参数（如速度、密度）及IO/通讯事件。
  
  - 生成可供协作机械臂直接运行的程序文件。
  
  - **仿真验证**规划的路径，确保无碰撞和符合工艺要求。
  
  - 通过软件直接连接并**控制机械臂进行在线调试**。

## 2. 软件输入项

本软件在进行机械臂路径规划时，需要用户提供以下输入信息：

---

### 2.1 三维模型数据

- **目的：** 提供工件的几何形状信息，作为用户点选路径的基础。

- **格式：** 支持主流的工业三维模型格式，主要包括：
  
  - **STEP (.step/.stp)：** Standard for the Exchange of Product model data。
  
  - **STL (.stl)：** Stereolithography。

### 2.2 人工点选路径数据

- **目的：** 定义机械臂在三维模型上需要执行操作的精确轨迹。

- **内容：** 用户在软件的三维视图界面上通过交互方式选择的点、线或曲面，以形成离散点序列或连续路径。点选完成后，软件将记录下所有路径的**起始点**、**终止点**以及**所有路径的先后执行顺序**。

### 2.3 工件空间偏移坐标

- **目的：** 补偿实际工件相对于机械臂基坐标系（或软件内部参考坐标系）的空间位置和姿态差异。

- **形式：** 软件需要提供界面供用户输入或示教此偏移量，可能包含：
  
  - **平移量：** 在X、Y、Z轴上的线性偏移。
  
  - **旋转量：** 绕X、Y、Z轴的旋转偏移（例如，欧拉角或四元数）。

### 2.4 路径段IO及通讯配置

- **目的：** 实现机械臂在路径执行过程中与外部设备（如点胶阀、焊接电源、喷枪、PLC等）的同步控制。

- **形式：** 允许用户为**每一段路径的开始和结束点**配置特定的数字量输出（DO）、数字量输入（DI）、模拟量输出（AO）或其他通讯协议（如TCP/IP、Modbus）的触发事件或等待条件。

### 2.5 路径运动参数

- **目的：** 定义机械臂执行每一段路径时的运动特性。

- **内容：**
  
  - **走点密度：** 决定了生成路径点的密集程度和轨迹的平滑度。
  
  - **速度：** 机械臂在执行该路径段时的线速度或角速度。

### 2.6 路径过渡与避让设定

- **目的：** 优化机械臂在不同路径段之间的运动衔接，提高效率并确保安全性。

- **内容：**
  
  - **过渡 (Blending/Cornering)：** 定义机械臂从一段路径的结束点平滑过渡到下一段路径的起始点的方式和程度。
  
  - **避让 (Retract/Approach)：** 定义机械臂在完成一段操作后如何抬起（Retract）以及在开始操作前如何靠近（Approach）工件的策略。

## 3. 软件输出项

本软件在处理用户输入并完成路径规划后，将提供以下核心输出：

---

### 3.1 工程文件

- **目的：** 保存软件中所有的用户设定、3D模型信息、人工点选路径数据、参数配置以及其他相关中间结果，以便后续**恢复工作状态**、**修改现有项目**或**复用已配置的方案**。

- **形式：** 建议采用**结构化的文本文件格式**，如 **XML (.xml)** 或 **JSON (.json)**。

### 3.2 机械臂点位程序文件

- **目的：** 将软件中规划的抽象路径转换为特定品牌机械臂控制器能够直接理解和执行的**程序代码**。

- **形式：** 输出文件格式将**高度依赖于目标机械臂的品牌和型号**。软件将需要内置一个或多个“后处理器”，根据用户选择的机械臂类型，生成对应的程序文件，例如URScript (`.script`)、RAPID (`.mod`)、KRL (`.src`)、TP (`.ls`) 等。

### 3.3 实时机械臂控制接口

- **目的：** 允许软件直接与机械臂控制器建立**实时通讯连接**，实现**在线程序调试**、**路径发送**和**直接运动指令控制**。

- **形式：** 主要通过**以太网 (TCP/IP)** 连接，并利用机械臂厂商提供的**API (Application Programming Interface)** 或 **SDK (Software Development Kit)** 进行数据交互。

### 3.4 机械臂运动仿真与视频输出

- **目的：** 在实际机械臂运行之前，通过**三维可视化仿真**对规划的路径进行**预验证**，检查是否存在碰撞、奇异点、运动极限等问题。同时，也可用于**展示项目效果**或**进行内部审查**。

- **形式：**
  
  - **软件内置仿真器：** 在软件的三维界面中实时模拟机械臂、工件和路径的运动。
  
  - **动画/视频文件：** 允许用户将仿真过程录制并导出为常见的视频格式（如 **MP4**、**AVI**）或动态图像（如 **GIF**）。

## 4. 软件外观与操作界面

本软件的用户界面设计旨在提供直观、高效且符合工程师操作习惯的体验。整体布局将围绕核心的3D操作界面展开，并辅以功能性面板，确保用户能够专注于路径规划与调试。

---

### 4.1 整体布局概览

软件主窗口将采用典型的工业设计软件布局，主要划分为以下几个区域：

- **顶部区域：** 包含菜单栏和工具栏，提供全局性功能和常用快捷操作。

- **主体区域：** 位于屏幕中央和左侧，为核心的3D操作界面，用于显示三维模型、机械臂以及规划的路径。

- **右侧区域：** 占据屏幕右侧至少三分之一的宽度，专门用于路径的管理、编辑和详细参数设定。

```
+-----------------------------------------------------------------------+
| 菜单栏 (文件, 编辑, 视图, 工具, 帮助)                                 |
+-----------------------------------------------------------------------+
| 工具栏 (常用功能图标: 导入3D, 保存, 导出机器人程序, 仿真, 测量等)      |
+-----------------------------------------------------------------------+
|                                  |                                   |
|                                  | **路径列表与管理区** |
|                                  | (显示所有路径段, 可拖拽排序,       |
|                                  |  显示/隐藏, 添加/删除/复制/重命名) |
|                                  |                                   |
|                                  | +--------------------------------+
|                                  | | 路径1 (点胶线 A) [✓] [👁️]       |
|                                  | | 路径2 (避让路径) [✓] [👁️]       |
|                                  | | 路径3 (点胶线 B) [✓] [👁️]       |
|                                  | | ...                              |
|                                  | +--------------------------------+
|                                  | |  [+ 添加] [🗑️ 删除] [📄 复制]      |
|                                  | +--------------------------------+
|                                  |                                   |
|          主 3D 操 作 界 面       |                                   |
|                                  | **路径详细设定/属性面板** |
|                                  | (当前选中路径的详细参数)          |
|                                  |                                   |
|                                  | +--------------------------------+
|                                  | | **通用参数** |
|                                  | |   速度: [_______] mm/s          |
|                                  | |   走点密度: [_______]            |
|                                  | |   参考坐标系: [下拉选择]         |
|                                  | |                                  |
|                                  | | **IO/通讯配置** |
|                                  | |   开始IO: [下拉选择] [值]        |
|                                  | |   结束IO: [下拉选择] [值]        |
|                                  | |                                  |
|                                  | | **过渡/避让设定** |
|                                  | |   过渡类型: [下拉选择]           |
|                                  | |   避让策略: [下拉选择]           |
|                                  | |   避让高度: [_______] mm         |
|                                  | |                                  |
|                                  | | **路径点编辑** (针对选中路径)    |
|                                  | |   点1: X[..] Y[..] Z[..] Rx[..]..|
|                                  | |   点2: X[..] Y[..] Z[..] Rx[..]..|
|                                  | |   [+ 添加点] [🗑️ 删除点]         |
|                                  | +--------------------------------+
+-----------------------------------------------------------------------+
```

### 4.2 主要界面区域功能详述

#### 4.2.1 菜单栏 (Top)

提供软件的全局性功能，例如：**文件** (新建、打开、保存、导入3D、导出机器人程序)、**编辑** (撤销、重做)、**视图** (视角控制、显示/隐藏元素)、**工具** (测量、坐标系设定)、**帮助**等。

#### 4.2.2 工具栏 (Top)

提供常用功能的快捷按钮，如**导入3D模型**、**保存工程**、**导出机器人程序**、**启动/暂停仿真**、**测量工具**、**路径绘制模式切换**（点位、直线、贴地线、曲线等）。

#### 4.2.3 主3D操作界面 (Center/Left)

这是软件的核心交互区域，用于**显示三维模型**、**机械臂**和**规划的路径**。用户在此区域进行路径的**点选、拖拽、选择、编辑**等操作，所有操作应与右侧面板实时联动，并提供即时视觉反馈。

#### 4.2.4 右侧“路径操作与设定”区域 (Right)

此区域是路径管理和详细配置的中心，分为两个主要子面板：

- **路径列表与管理区 (Path List & Management)：** 以列表形式展示所有路径段，提供**名称/编号**、**状态指示**、**可见性控制**和**拖拽排序**功能。同时提供**添加、删除、复制、重命名**等路径管理操作。

- **路径详细设定/属性面板 (Path Details & Properties)：** 显示当前选中路径的所有可编辑属性和参数，包括**通用运动参数**（速度、走点密度）、**IO/通讯配置**（路径开始和结束时的IO触发）、**过渡/避让设定**（运动衔接策略）以及**路径点编辑**（详细坐标和姿态调整）。

## 5. 路径编辑与生成的核心交互

本软件在三维操作界面中提供多种直观且精确的交互方式，使用户能够高效地定义和编辑机械臂的运动路径。核心交互理念是结合**多模式绘制**、**智能几何捕捉**和**强大的几何辅助功能**。

---

### 5.1 核心交互模式概述

用户可以在软件的工具栏或右侧的“路径列表与管理区”选择以下不同的路径绘制模式：

- **基本点位路径：** 定义离散的空间点位。

- **直线路径：** 定义连接两个或多个点的直线轨迹。

- **贴地线路径 (Follow Surface Path)：** 生成紧密贴合三维模型表面轮廓的路径。

- **曲线路径 (Spline/Arc Path)：** 定义平滑的曲线轨迹，包括贝塞尔曲线、B样条曲线或圆弧。

### 5.2 详细操作流程与交互方式

#### 5.2.1 基本点位路径

用户在3D模型表面或空间中直接点击鼠标即可定义点位，软件提供**智能捕捉**功能（顶点、边中点、面中心等）。

#### 5.2.2 直线路径

用户依次点击多个点来定义直线段。软件支持**实时预览**和全面的**几何捕捉**（顶点、边、面、几何交点、中心等），并支持连续多段直线绘制。

#### 5.2.3 贴地线路径 (Follow Surface Path)

用户通过在3D模型表面点击起始点或选择起始边，并沿着表面拖动鼠标来引导路径生成。软件会根据模型表面的几何信息自动计算并生成贴合表面的路径点。此外，提供强大的**几何辅助功能**：

- **投影至表面：** 将在空间中绘制的直线或曲线投影到选定模型表面。

- **偏移表面：** 在现有贴地路径基础上，生成一条平行且有特定**偏移量**的路径。

- **沿着特定边生成：** 直接选择模型上的边并转换为贴地路径。

- **横截面生成：** 通过定义切割平面，将其与模型的交线转换为贴地路径。

#### 5.2.4 曲线路径 (Spline/Arc Path)

用户通过点选多个**控制点**来定义曲线形状。对于圆弧，可采用三点定义方式。软件会实时绘制平滑曲线，并支持控制点编辑。

#### 5.2.5 姿态 (Tool Orientation) 设定

- **目的：** 控制机械臂末端工具相对于路径点的空间姿态。

- **交互：**
  
  - **自动生成：** 对于贴地路径，可根据模型表面**法线方向**自动生成默认姿态，并允许设置**固定角度偏移**。
  
  - **手动调整：** 通过右侧属性面板的**姿态调整控件**或3D视图中拖动显示的**工具坐标系轴**进行直观调整。
  
  - **复制功能：** 支持将一个点的姿态复制到其他点或整个路径段。

---

这份文档涵盖了我们目前讨论的所有核心需求、输入、输出、界面和核心交互。接下来，我们可以继续深入讨论软件的其他方面，例如：

- **机械臂模型管理：** 如何导入和管理不同品牌的机械臂模型？

- **仿真功能：** 除了轨迹显示，是否需要碰撞检测、可达性分析等？

- **后端技术选型：** 针对3D显示、几何处理、机器人通讯等，有哪些技术栈可以考虑？

## 6. 推荐的插件+脚本架构

**通过插件 (Plugin) 和脚本 (Script) 的方式来实现软件的大多数功能，对于具有高度定制化和扩展性需求的工业软件来说，是一种非常理想的架构。**这种模式能够实现功能的高度解耦、灵活扩展和快速迭代。

---

### 6.1 核心层 (Core/Kernel)

这是软件的基石，提供最基础的服务和运行环境，保持尽可能小且稳定。

- **核心功能：**
  
  - **应用程序生命周期管理：** 启动、关闭、错误处理。
  
  - **UI框架：** 提供窗口、控件、布局等基础UI组件，以及3D渲染引擎的接口。
  
  - **插件管理：** 负责加载、卸载、管理插件的生命周期和相互发现，是插件式架构的核心。
  
  - **脚本引擎集成：** 嵌入一个脚本解释器（强烈推荐Python），并提供脚本与核心及插件交互的API。
  
  - **数据模型基类：** 定义通用的数据结构，如几何体、点、路径等的基础抽象。
  
  - **事件系统/消息总线：** 用于核心、插件和脚本之间进行通讯和事件通知。
  
  - **日志系统：** 记录软件运行状态和错误。

### 6.2 插件层 (Plugin Layer)

这一层包含所有特定功能的实现，它们以插件的形式加载到核心中，每个插件专注于一个或几个紧密相关的功能。

- **插件类型示例：**
  
  - **3D模型导入插件：** 负责解析STEP、STL等文件格式，并转换为内部数据模型。
  
  - **机械臂模型管理插件：** 负责加载不同品牌（UR、ABB、KUKA等）的机械臂模型数据，并可能包含运动学（正逆解）抽象接口。
  
  - **路径绘制工具插件：** 实现具体的路径绘制模式（直线、贴地线、曲线、点位等）及其交互逻辑。
  
  - **后处理器插件 (Robot Code Generator)：** **关键插件。** 每个机械臂品牌/型号对应一个，将内部通用路径数据转换为特定机械臂的编程语言（URScript, RAPID, KRL等）。
  
  - **机器人通讯插件：** 实现与特定机械臂品牌的实时通讯协议（如UR的RTDE、ABB的EGM）。
  
  - **仿真与可视化插件：** 渲染机械臂模型和路径动画，可包含碰撞检测、可达性分析等功能。
  
  - **IO/通讯配置插件：** 管理IO点位和通讯变量的配置界面和逻辑。
  
  - **测量与分析工具插件：** 提供各种测量、检查、优化工具。

### 6.3 脚本层 (Script Layer)

脚本作为一种更轻量级、更灵活的扩展方式，允许用户或开发者在运行时快速编写和执行逻辑。脚本引擎（推荐Python）通过暴露的API与核心和插件层交互。脚本可分为两种主要类型：

#### 6.3.1 配置与扩展脚本 (Configuration & Extension Scripts)

- **目的：** 用于**初始化、定制软件行为**或**扩展插件功能**，类似于高级配置文件。

- **应用场景：**
  
  - **启动脚本：** 软件启动时加载特定插件、设置默认参数。
  
  - **插件配置脚本：** 定义插件的加载行为、暴露接口或执行内部初始化。
  
  - **UI定制脚本：** 动态修改或生成部分UI布局、菜单项。
  
  - **事件响应脚本：** 监听软件事件，触发自定义行为。

- **特点：** 通常由软件开发者或高级用户编写，在软件启动或特定模块加载时执行，调整或增强软件的基础能力。

#### 6.3.2 业务逻辑脚本 (Business Logic Scripts)

- **目的：** 直接参与到**解决用户具体问题**的流程中，实现自动化、批处理或特定的算法。

- **应用场景：**
  
  - **自动化路径生成：** 根据模型特征（如所有圆孔边缘）自动生成路径。
  
  - **批量处理：** 导入多个模型，批量生成路径并导出程序。
  
  - **自定义优化算法：** 实现路径平滑、点位优化或工具姿态调整等高级算法。
  
  - **外部系统集成：** 与MES系统、生产管理系统进行数据交互。
  
  - **高级仿真场景：** 控制仿真过程，进行参数扫描或复杂场景模拟。

- **特点：** 直接操作软件暴露的API，执行具体的业务流程。可在软件运行时由用户按需触发，实现高度定制化的工作流。

### 6.4 数据层 (Data Layer)

- **内部数据模型：** 软件内部统一的3D几何数据结构、路径数据结构、机械臂关节数据、工具数据、IO配置数据等。这是核心层和所有插件/脚本共享和操作的数据基础。

- **工程文件持久化：** 将内部数据模型序列化为工程文件（如JSON/XML）进行存储和加载。

---

### 6.5 实现这种架构的关键点：

1. **明确的接口定义 (API)：** 核心层需定义清晰的接口供插件注册和调用；插件之间也可能需要协作接口。脚本层通过这些接口与整个系统交互。

2. **依赖注入或服务定位器：** 管理插件间的依赖关系。

3. **配置文件：** 管理插件的加载顺序、激活状态和配置参数。

4. **错误隔离：** 确保一个插件的崩溃不影响整个软件。

5. **版本管理：** 应对插件和核心之间的版本兼容性问题。
